<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaming CafÃ© - GAMERSTOWN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        accent: '#f093fb',
                    },
                    fontFamily: {
                        'gaming': ['Orbitron', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-primary to-secondary shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-white text-2xl font-gaming font-bold">
                        ðŸŽ® GAMERSTOWN
                    </a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="text-white hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</a>
                        <a href="explore.html" class="text-white hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium transition-colors">Explore</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4" id="authButtons">
                    <a href="login.html" class="text-white border border-white px-4 py-2 rounded-lg hover:bg-white hover:text-primary transition-all">Login</a>
                    <a href="register.html" class="bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 transition-all font-medium">Sign Up</a>
                </div>
                <div class="hidden items-center space-x-4" id="userMenu">
                    <span class="text-white" id="userName"></span>
                    <div class="relative">
                        <button class="text-white hover:text-gray-300" id="userDropdown" onclick="window.location.href='user-dashboard.html'">
                            <i class="fas fa-user-circle text-2xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- CafÃ© Details -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8" id="cafeDetails">
            <!-- Content will be loaded dynamically -->
        </div>

        <!-- Booking Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Slot Selection -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">Select Your Gaming Slot</h3>
                    
                    <!-- Date Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Date</label>
                        <input type="date" id="bookingDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>

                    <!-- Time Slots -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-4">Available Time Slots</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="timeSlots">
                            <!-- Time slots will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Number of Players -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Number of Players</label>
                        <select id="numberOfPlayers" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="1">1 Player</option>
                            <option value="2">2 Players</option>
                            <option value="3">3 Players</option>
                            <option value="4">4 Players</option>
                            <option value="5">5+ Players</option>
                        </select>
                    </div>

                    <!-- Special Requests -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Special Requests (Optional)</label>
                        <textarea id="specialRequests" rows="3" placeholder="Any special requirements or preferences..."
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                </div>
            </div>

            <!-- Booking Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Booking Summary</h3>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="text-gray-600">CafÃ©:</span>
                            <span class="font-medium" id="summaryName">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-medium" id="summaryDate">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Time:</span>
                            <span class="font-medium" id="summaryTime">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Players:</span>
                            <span class="font-medium" id="summaryPlayers">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Duration:</span>
                            <span class="font-medium">1 Hour</span>
                        </div>
                        <hr>
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total:</span>
                            <span class="text-primary" id="summaryTotal">â‚¹0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Wallet Balance:</span>
                            <span class="font-medium" id="walletBalance">â‚¹0</span>
                        </div>
                    </div>

                    <button onclick="proceedToBooking()" id="bookButton" 
                            class="w-full bg-primary hover:bg-secondary text-white py-3 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-calendar-plus mr-2"></i>Book Now
                    </button>

                    <!-- Cancellation Policy -->
                    <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-semibold text-yellow-800 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Cancellation Policy
                        </h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>â€¢ Free cancellation up to 2 hours before</li>
                            <li>â€¢ 50% refund if cancelled 1-2 hours before</li>
                            <li>â€¢ No refund if cancelled within 1 hour</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="bg-white rounded-2xl shadow-lg mt-8">
            <div class="p-6 border-b">
                <h3 class="text-2xl font-bold text-gray-900">Reviews & Ratings</h3>
                <div class="flex items-center mt-2">
                    <div class="flex items-center">
                        <i class="fas fa-star text-yellow-400 mr-1"></i>
                        <span class="text-lg font-semibold" id="averageRating">4.5</span>
                        <span class="text-gray-500 ml-2">(<span id="totalReviews">120</span> reviews)</span>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div id="reviewsContainer">
                    <!-- Reviews will be loaded here -->
                </div>
                
                <!-- Write Review Button -->
                <div class="mt-6 text-center">
                    <button onclick="openReviewModal()" class="bg-primary hover:bg-secondary text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-star mr-2"></i>Write a Review
                    </button>
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div id="reviewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Write a Review</h3>
                        <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="reviewForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                            <div class="flex space-x-1" id="starRating">
                                <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="1">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="2">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="3">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="4">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="5">
                                    <i class="fas fa-star"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label for="reviewComment" class="block text-sm font-medium text-gray-700 mb-2">Your Review</label>
                            <textarea id="reviewComment" rows="4" placeholder="Share your experience at this gaming cafÃ©..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" required></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-primary hover:bg-secondary text-white py-3 rounded-lg font-medium transition-colors">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Review
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Insufficient Balance Modal -->
    <div id="insufficientBalanceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Insufficient Balance</h3>
                    <button onclick="closeInsufficientBalanceModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="bg-red-100 text-red-800 p-4 rounded-lg mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="font-semibold">Insufficient wallet balance!</p>
                        <p class="text-sm mt-2">You need <span id="requiredAmount">â‚¹0</span> but only have <span id="currentBalance">â‚¹0</span></p>
                    </div>
                    
                    <p class="text-gray-600 mb-4">Please add money to your wallet to complete this booking.</p>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeInsufficientBalanceModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button onclick="redirectToDashboard()" class="flex-1 bg-primary hover:bg-secondary text-white py-3 rounded-lg font-medium transition-colors">
                        Add Money
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-16 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="col-span-1 md:col-span-2">
                    <h3 class="text-2xl font-gaming font-bold mb-4">ðŸŽ® GAMERSTOWN</h3>
                    <p class="text-gray-400 mb-6">Your ultimate destination for gaming cafÃ© bookings.</p>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="explore.html" class="text-gray-400 hover:text-white transition-colors">Explore CafÃ©s</a></li>
                        <li><a href="register.html" class="text-gray-400 hover:text-white transition-colors">Sign Up</a></li>
                        <li><a href="login.html" class="text-gray-400 hover:text-white transition-colors">Login</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Support</h4>
                    <ul class="space-y-2">
                        <li><a href="help-center.html" class="text-gray-400 hover:text-white transition-colors">Help Center</a></li>
                        <li><a href="contact-us.html" class="text-gray-400 hover:text-white transition-colors">Contact Us</a></li>
                        <li><a href="terms-of-service.html" class="text-gray-400 hover:text-white transition-colors">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-12 pt-8 text-center">
                <p class="text-gray-400">&copy; 2024 GAMERSTOWN. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        let currentCafe = null;
        let selectedSlot = null;
        let bookedSlots = [];
        let userWalletBalance = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            updateNavigation();
            await loadCafeDetails();
            setupBookingForm();
            loadUserWalletBalance();
        });

        function loadUserWalletBalance() {
            const user = JSON.parse(localStorage.getItem('user'));
            userWalletBalance = parseInt(localStorage.getItem('walletBalance')) || (user ? user.walletBalance : 0) || 0;
            document.getElementById('walletBalance').textContent = `â‚¹${userWalletBalance.toLocaleString()}`;
        }

        async function loadCafeDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const cafeId = urlParams.get('id');

            if (!cafeId) {
                window.location.href = 'explore.html';
                return;
            }

            try {
                // Enhanced mock cafÃ© data with updated images
                const mockCafes = {
                    '1': {
                        _id: '1',
                        name: 'Gaming Zone Pro',
                        city: 'Bangalore',
                        address: 'MG Road, Bangalore',
                        hourlyRate: 150,
                        averageRating: 4.5,
                        totalReviews: 120,
                        amenities: ['High-end PCs', 'PS5', 'Xbox', 'VR', 'High-speed Internet', 'Air Conditioning'],
                        games: ['Valorant', 'CS:GO', 'Dota 2', 'Apex Legends', 'Fortnite'],
                        image: 'https://images.unsplash.com/photo-1542751371-adc38448a05e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                        isOpen: true,
                        description: 'Experience gaming like never before with our state-of-the-art gaming setups and comfortable environment. Perfect for competitive gaming and casual sessions.',
                        openingTime: '10:00',
                        closingTime: '23:00',
                        phone: '+91 9876543210'
                    },
                    '2': {
                        _id: '2',
                        name: 'Cyber Arena',
                        city: 'Mumbai',
                        address: 'Bandra West, Mumbai',
                        hourlyRate: 200,
                        averageRating: 4.3,
                        totalReviews: 89,
                        amenities: ['Gaming PCs', 'PS4', 'Nintendo Switch', 'Food Court', 'Tournament Stage'],
                        games: ['League of Legends', 'Overwatch', 'PUBG', 'Fortnite', 'Rocket League'],
                        image: 'https://images.unsplash.com/photo-1511512578047-dfb367046420?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                        isOpen: true,
                        description: 'Esports focused gaming cafÃ© with tournament facilities and professional gaming setups.',
                        openingTime: '09:00',
                        closingTime: '00:00',
                        phone: '+91 9876543211'
                    },
                    '3': {
                        _id: '3',
                        name: 'Elite Gaming Hub',
                        city: 'Delhi',
                        address: 'Connaught Place, Delhi',
                        hourlyRate: 180,
                        averageRating: 4.7,
                        totalReviews: 156,
                        amenities: ['RTX 4080 PCs', 'PS5', 'Xbox Series X', 'VR Headsets', 'Premium Seating'],
                        games: ['Cyberpunk 2077', 'Elden Ring', 'God of War', 'Red Dead Redemption 2'],
                        image: 'https://images.unsplash.com/photo-1493711662062-fa541adb3fc8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                        isOpen: true,
                        description: 'Luxury gaming lounge with premium setups and exclusive gaming titles.',
                        openingTime: '11:00',
                        closingTime: '01:00',
                        phone: '+91 9876543212'
                    },
                    '4': {
                        _id: '4',
                        name: 'Game Nexus',
                        city: 'Hyderabad',
                        address: 'HITEC City, Hyderabad',
                        hourlyRate: 120,
                        averageRating: 4.2,
                        totalReviews: 95,
                        amenities: ['Gaming PCs', 'Consoles', 'Snacks', 'WiFi', 'Lounge Area'],
                        games: ['Minecraft', 'Among Us', 'Rocket League', 'Fall Guys'],
                        image: 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                        isOpen: false,
                        description: 'Community gaming space perfect for casual players and group sessions.',
                        openingTime: '10:00',
                        closingTime: '22:00',
                        phone: '+91 9876543213'
                    },
                    '5': {
                        _id: '5',
                        name: 'Arcade Alley',
                        city: 'Chennai',
                        address: 'T. Nagar, Chennai',
                        hourlyRate: 100,
                        averageRating: 4.0,
                        totalReviews: 78,
                        amenities: ['Arcade Machines', 'Retro Games', 'Snack Bar', 'Party Rooms'],
                        games: ['Street Fighter', 'Mortal Kombat', 'Pac-Man', 'Tekken'],
                        image: '/images/arcade-alley.jpg',
                        isOpen: true,
                        description: 'Retro gaming paradise with classic arcade games and nostalgic atmosphere.',
                        openingTime: '09:00',
                        closingTime: '23:00',
                        phone: '+91 9876543214'
                    },
                    '6': {
                        _id: '6',
                        name: 'Next Level Lounge',
                        city: 'Pune',
                        address: 'Koregaon Park, Pune',
                        hourlyRate: 160,
                        averageRating: 4.6,
                        totalReviews: 112,
                        amenities: ['Latest Consoles', 'Comfortable Seating', 'Energy Drinks', 'Tournament Setup'],
                        games: ['FIFA 24', 'NBA 2K', 'Call of Duty', 'Forza Horizon'],
                        image: '/images/next-level-lounge.jpg',
                        isOpen: true,
                        description: 'Modern gaming lounge with latest titles and comfortable gaming environment.',
                        openingTime: '10:00',
                        closingTime: '00:00',
                        phone: '+91 9876543215'
                    }
                };

                currentCafe = mockCafes[cafeId];
                if (!currentCafe) {
                    window.location.href = 'explore.html';
                    return;
                }

                // Load booked slots for this cafe
                const savedBookings = localStorage.getItem('userBookings');
                if (savedBookings) {
                    const allBookings = JSON.parse(savedBookings);
                    bookedSlots = allBookings
                        .filter(booking => booking.cafeId === cafeId && booking.status !== 'cancelled')
                        .map(booking => booking.slot);
                }

                displayCafeDetails();
                loadTimeSlots();
                updateBookingSummary();
                loadReviews();
            } catch (error) {
                console.error('Error loading cafÃ© details:', error);
                showError('Failed to load cafÃ© details');
            }
        }

        function displayCafeDetails() {
            const cafeDetails = document.getElementById('cafeDetails');
            
            cafeDetails.innerHTML = `
                <div class="relative">
                    <img src="${currentCafe.image}" alt="${currentCafe.name}" class="w-full h-64 object-cover">
                    <div class="absolute top-4 right-4">
                        <span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">
                            ${currentCafe.isOpen ? 'Open' : 'Closed'}
                        </span>
                    </div>
                </div>
                <div class="p-8">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">${currentCafe.name}</h1>
                            <p class="text-gray-600 flex items-center">
                                <i class="fas fa-map-marker-alt mr-2"></i>${currentCafe.address}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-star text-yellow-400 mr-1"></i>
                                <span class="text-lg font-semibold">${currentCafe.averageRating}</span>
                                <span class="text-gray-500 ml-1">(${currentCafe.totalReviews} reviews)</span>
                            </div>
                            <div class="text-2xl font-bold text-primary">â‚¹${currentCafe.hourlyRate}/hour</div>
                        </div>
                    </div>
                    
                    <p class="text-gray-700 mb-6">${currentCafe.description}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3">Amenities</h3>
                            <div class="flex flex-wrap gap-2">
                                ${currentCafe.amenities.map(amenity => 
                                    `<span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">${amenity}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3">Popular Games</h3>
                            <div class="flex flex-wrap gap-2">
                                ${currentCafe.games.map(game => 
                                    `<span class="bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full">${game}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3">Operating Hours</h3>
                            <p class="text-gray-600">
                                <i class="fas fa-clock mr-2"></i>${currentCafe.openingTime} - ${currentCafe.closingTime}
                            </p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3">Contact</h3>
                            <p class="text-gray-600">
                                <i class="fas fa-phone mr-2"></i>${currentCafe.phone}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            const selectedDate = document.getElementById('bookingDate').value;
            
            if (!selectedDate || !currentCafe) return;

            // Parse opening and closing times
            const [openHour] = currentCafe.openingTime.split(':').map(Number);
            const [closeHour] = currentCafe.closingTime.split(':').map(Number);
            
            // Generate time slots
            const timeSlots = [];
            let startHour = openHour;
            let endHour = closeHour;
            
            // Handle midnight closing (e.g., 00:00 or 01:00)
            if (closeHour <= 6) {
                endHour = closeHour + 24;
            }
            
            for (let hour = startHour; hour < endHour; hour++) {
                const displayHour = hour > 23 ? hour - 24 : hour;
                const nextDisplayHour = (hour + 1) > 23 ? (hour + 1) - 24 : (hour + 1);
                
                const startTime = `${displayHour.toString().padStart(2, '0')}:00`;
                const endTime = `${nextDisplayHour.toString().padStart(2, '0')}:00`;
                const slot = `${startTime}-${endTime}`;
                timeSlots.push(slot);
            }

            timeSlotsContainer.innerHTML = '';
            
            timeSlots.forEach(slot => {
                const isBooked = bookedSlots.includes(slot);
                const button = document.createElement('button');
                button.className = `p-3 border-2 rounded-lg font-medium transition-all ${
                    isBooked 
                        ? 'border-red-200 bg-red-50 text-red-400 cursor-not-allowed' 
                        : 'border-gray-200 hover:border-primary hover:bg-blue-50 text-gray-700'
                }`;
                button.textContent = slot;
                button.disabled = isBooked;
                
                if (isBooked) {
                    button.innerHTML += '<br><small class="text-xs">Booked</small>';
                } else {
                    button.addEventListener('click', () => selectTimeSlot(slot, button));
                }
                
                timeSlotsContainer.appendChild(button);
            });
        }

        function setupBookingForm() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').min = today;
            document.getElementById('bookingDate').value = today;

            // Add event listeners
            document.getElementById('bookingDate').addEventListener('change', loadTimeSlots);
            document.getElementById('numberOfPlayers').addEventListener('change', updateBookingSummary);
        }

        function selectTimeSlot(slot, buttonElement) {
            // Remove previous selection
            document.querySelectorAll('#timeSlots button').forEach(btn => {
                if (!btn.disabled) {
                    btn.classList.remove('border-primary', 'bg-blue-100', 'text-primary');
                    btn.classList.add('border-gray-200', 'text-gray-700');
                }
            });

            // Add selection to clicked button
            buttonElement.classList.remove('border-gray-200', 'text-gray-700');
            buttonElement.classList.add('border-primary', 'bg-blue-100', 'text-primary');
            
            selectedSlot = slot;
            updateBookingSummary();
        }

        function updateBookingSummary() {
            const date = document.getElementById('bookingDate').value;
            const players = document.getElementById('numberOfPlayers').value;
            const bookButton = document.getElementById('bookButton');

            // Update summary display
            document.getElementById('summaryName').textContent = currentCafe ? currentCafe.name : '-';
            document.getElementById('summaryDate').textContent = date ? new Date(date).toLocaleDateString() : '-';
            document.getElementById('summaryTime').textContent = selectedSlot || '-';
            document.getElementById('summaryPlayers').textContent = players ? `${players} Player${players > 1 ? 's' : ''}` : '-';
            
            // Calculate total
            const total = currentCafe && selectedSlot ? currentCafe.hourlyRate * parseInt(players) : 0;
            document.getElementById('summaryTotal').textContent = `â‚¹${total}`;

            // Enable/disable book button
            const canBook = currentCafe && date && selectedSlot && players;
            bookButton.disabled = !canBook;
        }

        function proceedToBooking() {
            if (!window.GAMERSTOWN.auth.isAuthenticated()) {
                showError('Please login to make a booking');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            const date = document.getElementById('bookingDate').value;
            const players = document.getElementById('numberOfPlayers').value;
            const total = currentCafe.hourlyRate * parseInt(players);

            // Check wallet balance
            if (userWalletBalance < total) {
                document.getElementById('requiredAmount').textContent = `â‚¹${total}`;
                document.getElementById('currentBalance').textContent = `â‚¹${userWalletBalance}`;
                document.getElementById('insufficientBalanceModal').classList.remove('hidden');
                document.getElementById('insufficientBalanceModal').classList.add('flex');
                return;
            }

            // Process booking
            processBooking(total);
        }

        function processBooking(total) {
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const bookingData = {
                    _id: Date.now().toString(),
                    cafeId: currentCafe._id,
                    cafeName: currentCafe.name,
                    cafeAddress: currentCafe.address,
                    date: document.getElementById('bookingDate').value,
                    slot: selectedSlot,
                    numberOfPlayers: parseInt(document.getElementById('numberOfPlayers').value),
                    specialRequests: document.getElementById('specialRequests').value,
                    totalAmount: total,
                    status: 'upcoming',
                    paymentStatus: 'paid',
                    bookingTime: new Date().toISOString(),
                    username: user.username || user.email.split('@')[0]
                };

                // Deduct from wallet
                userWalletBalance -= total;
                localStorage.setItem('walletBalance', userWalletBalance.toString());
                
                // Update user data
                if (user) {
                    user.walletBalance = userWalletBalance;
                    localStorage.setItem('user', JSON.stringify(user));
                }

                // Save booking
                const existingBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
                existingBookings.push(bookingData);
                localStorage.setItem('userBookings', JSON.stringify(existingBookings));

                // Add to booked slots
                bookedSlots.push(selectedSlot);

                showSuccess('Booking confirmed! Payment successful.');
                
                setTimeout(() => {
                    window.location.href = 'user-dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('Booking error:', error);
                showError('Booking failed. Please try again.');
            }
        }

        function closeInsufficientBalanceModal() {
            document.getElementById('insufficientBalanceModal').classList.add('hidden');
            document.getElementById('insufficientBalanceModal').classList.remove('flex');
        }

        function redirectToDashboard() {
            window.location.href = 'user-dashboard.html';
        }

        function updateNavigation() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const authButtons = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');

            if (token && user) {
                const userData = JSON.parse(user);
                authButtons.style.display = 'none';
                userMenu.style.display = 'flex';
                userName.textContent = userData.username || userData.email.split('@')[0];
            } else {
                authButtons.style.display = 'flex';
                userMenu.style.display = 'none';
            }
        }

        // Review functionality
        let selectedRating = 0;

        function loadReviews() {
            if (currentCafe) {
                const savedReviews = localStorage.getItem(`reviews_${currentCafe._id}`);
                let reviews = [];
                
                if (savedReviews) {
                    reviews = JSON.parse(savedReviews);
                } else {
                    // Mock reviews
                    reviews = [
                        {
                            _id: '1',
                            username: 'GamerPro123',
                            rating: 5,
                            comment: 'Amazing gaming setup! The PCs are top-notch and the staff is very helpful.',
                            createdAt: '2024-12-15T10:30:00Z'
                        },
                        {
                            _id: '2',
                            username: 'TechGuru',
                            rating: 4,
                            comment: 'Good facilities and friendly staff. Will definitely visit again!',
                            createdAt: '2024-12-10T15:20:00Z'
                        }
                    ];
                }
                
                displayReviews(reviews);
            }
        }

        function displayReviews(reviews) {
            const reviewsContainer = document.getElementById('reviewsContainer');
            
            if (reviews.length === 0) {
                reviewsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-star text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">No reviews yet</h3>
                        <p class="text-gray-500">Be the first to review this gaming cafÃ©!</p>
                    </div>
                `;
                return;
            }

            reviewsContainer.innerHTML = reviews.map(review => {
                const date = new Date(review.createdAt).toLocaleDateString();
                const stars = Array.from({ length: 5 }, (_, i) =>
                    i < review.rating ? '<i class="fas fa-star text-yellow-400"></i>' : '<i class="far fa-star text-gray-300"></i>'
                ).join('');

                return `
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-900">${review.username}</h4>
                                <div class="flex items-center mt-1">
                                    ${stars}
                                    <span class="ml-2 text-sm text-gray-600">${review.rating}/5</span>
                                </div>
                            </div>
                            <span class="text-sm text-gray-500">${date}</span>
                        </div>
                        <p class="text-gray-700">${review.comment}</p>
                    </div>
                `;
            }).join('');
        }

        function openReviewModal() {
            const token = localStorage.getItem('token');
            if (!token) {
                showError('Please login to write a review');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            document.getElementById('reviewModal').classList.remove('hidden');
            document.getElementById('reviewModal').classList.add('flex');
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
            document.getElementById('reviewModal').classList.remove('flex');
            resetReviewForm();
        }

        function resetReviewForm() {
            selectedRating = 0;
            document.getElementById('reviewComment').value = '';
            document.querySelectorAll('.star-btn').forEach(btn => {
                btn.classList.remove('text-yellow-400');
                btn.classList.add('text-gray-300');
            });
        }

        // Star rating functionality
        document.addEventListener('DOMContentLoaded', () => {
            const starButtons = document.querySelectorAll('.star-btn');
            
            starButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectedRating = parseInt(btn.dataset.rating);
                    
                    starButtons.forEach((star, index) => {
                        if (index < selectedRating) {
                            star.classList.remove('text-gray-300');
                            star.classList.add('text-yellow-400');
                        } else {
                            star.classList.remove('text-yellow-400');
                            star.classList.add('text-gray-300');
                        }
                    });
                });
                
                btn.addEventListener('mouseenter', () => {
                    const rating = parseInt(btn.dataset.rating);
                    starButtons.forEach((star, index) => {
                        if (index < rating) {
                            star.classList.add('text-yellow-400');
                        } else {
                            star.classList.remove('text-yellow-400');
                        }
                    });
                });
            });
            
            document.getElementById('starRating').addEventListener('mouseleave', () => {
                starButtons.forEach((star, index) => {
                    if (index < selectedRating) {
                        star.classList.add('text-yellow-400');
                        star.classList.remove('text-gray-300');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });
            });
        });

        // Review form submission
        document.getElementById('reviewForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (selectedRating === 0) {
                showError('Please select a rating');
                return;
            }
            
            const comment = document.getElementById('reviewComment').value.trim();
            if (!comment) {
                showError('Please write a review comment');
                return;
            }
            
            const user = JSON.parse(localStorage.getItem('user'));
            const review = {
                _id: Date.now().toString(),
                username: user.username || user.email.split('@')[0],
                rating: selectedRating,
                comment: comment,
                createdAt: new Date().toISOString()
            };
            
            // Save review to localStorage
            const existingReviews = JSON.parse(localStorage.getItem(`reviews_${currentCafe._id}`) || '[]');
            existingReviews.unshift(review);
            localStorage.setItem(`reviews_${currentCafe._id}`, JSON.stringify(existingReviews));
            
            // Refresh reviews display
            displayReviews(existingReviews);
            
            showSuccess('Review submitted successfully!');
            closeReviewModal();
        });

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 max-w-sm';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 max-w-sm';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }
    </script>
</body>
</html>
